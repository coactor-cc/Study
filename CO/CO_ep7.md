# I/O系统
## 概述
### 任务
实现主机与外设的信息交换`链接方式+控制方式 ` 
### 过程
总线操作`CPU-接口侧`+通信操作`接口-设备侧`
### 组成
硬件=外设、I/O接口、总线、传送控制部件  
软件=I/O指令|通道指令、I/O程序`设备驱动程序`
![Alt text](images/CO_ep7_image-13.png)
### 评价指标
响应时间
吞吐率
I/O占CPU的时间

### 外设与主机的联系
CPU-总线-I/O接口-外设
#### 链接方式：总线  
#### 编址方式：
统一编址：不增加指令数，主存空间变小，不易扩展译码复杂  
独立编址：增加两条机器指令，空间不影响，易扩展译码简单  
#### 识别方法：唯一设备号`设备ID`
在I/O接口中由硬件记录，通过设备选择电路，在控制信号到来时，将ABus和自身ID进行比较

`地址高位作为ID低位选择端口`  
![Alt text](images/CO_ep7_image-12.png)
#### 接口与外设联络方式`上为主机-接口侧`
##### 数据传送
无条件
同步传输，对于外设来说主机输出外设一定准备就绪    
条件
异步传输，等设备就绪，如读取磁盘，打印  
##### `信号定时`(外设与接口的联络)
联络信号线：CLK、Req、Ack  


无条件(立即响应) 数据线n`无需RAC`  
条件(异步)   
并行 数据线n、Req、Ack  
串行  异步：1+Req、Ack  ；同步：数据线1、CLK  
![Alt text](images/CO_ep7_image-14.png)  
`串行传送中的省略方法`：  
CLK:`串行同步`采取帧头帧尾信息中的同步信息产生连续跳变替代  
Req：`串行异步`采取帧头帧尾信息不同来省略  
Ack：`串行异步`采取不互锁来省略
## I/O设备 
### 概述
#### 组成
部件+驱动器+(设备)控制器--》接到I/O接口  
![Alt text](images/CO_ep7_image-2.png)
#### 按批量传输分
字符设备、块设备
![Alt text](images/CO_ep7_image-1.png)
#### 设备功能
人-机交互、机-机通信、存储
#### I/O方向
输入、输出、输入/输出



### 输入设备
#### 键盘
非编码、编码
#### 鼠标
机械鼠、光电鼠
### 输出
#### 显示器
种类：阴极射线管(CRT)、液晶(LCD)、等离子(PDP)等  
技术指标：分辨率、灰度级(彩色包含颜色、亮度、饱和度)
##### LCD(Liquid Crystal Display)
液晶材料：  
物理特性—棒状长分子结构，沿长轴方向平行排列(晶态时)  
光学特性—旋光性、透光性  
应用  
亮/灭用旋光性控制 (偏光片[X及Y]＋分子排列[扭曲/平行])  
灰度用透光性控制  (分子排列的倾向角[不同电压值])  
颜色用滤光片控制  (红色＋绿色＋蓝色)  

液晶单元  
偏光片+分子扭曲排列，用电压控制灰度  

LCD组成  
每个像素点由3个单元组成，显示控制采用行扫描方式(共用门电极、控制各列源电极)

接口  
VGA(Video Graphics Array)  
1、是**模拟信号**的传输，随着显示器的分辨率越高画面就会越模糊。一般模拟信号在超过1280×1024分辨率以上的情况下就会出现明显的误差。  
2、因为是模拟信息，信号极其容易受干扰。  
3、不能传达音频。  
4、一般不加放大器和转换器在30米左右，加放大器和放大转换器可以到150米。  
DVI(Digital Visual Interface)  
1、**数字信号**，避免了模/数转换过程，信号没有衰减，色彩更
纯净、逼真。  
2、只传送视频信号，不传送音频信号。  
3、支持多种格式，包括1920*1080全部高清格式。  
4、有效传输距离仅5米左右。  
HDMI(High Definition Multimedia Interface)  
1、可以传送无压缩的**音频信号**及高分辨率**视频信号**，数字信号，质量高。    
2、提高高达5Gbps的数据传输带宽。  
3、最高能支持1080P视频。  
4、理论20m，但需要质量好的线，实际市面上的一般15米内。  
5、同时传输音频、视频、版权保护，在消费电子领域非常受欢迎。  
6、HDMI是外部接口，对于视频的分辨率和色深的提升能力有限。  
7、HDMI兼容性不好。
#### 打印机 
击打式(机械式/针式)、非击打式(激光/喷墨)  
打印机接口：Centronics或USB  
### 外存储器`以磁盘为重点`
#### 概念
具有非易失性  
磁表面|光 盘状|带状`存储器匀速转动、读写头不动`

磁盘
盘面——
磁道——
扇区——记录块(多个数据)
#### 辅存性能指标：
##### 存储密度   
单位面积能存储的二进制信息量  
Ds＝道密度×位密度  
##### 存储容量  
辅存所能存储的二进制信息总量  
S＝磁道数×磁道长度×记录密度`线密度`   

非格式化容量：记录密度=位密度  
格式化容量(70%)：记录密度<位密度`存放块号，校验位等`
##### 寻址时间  
从读写头起始位置移动到读写位置的时间  
寻址时间($T_a$)＝平均寻道时间($t_s$)＋平均等待时间($t_w$) `极坐标系理解`   
平均等待=转半圈的时间  
##### `数据传输率` 
难点易混点   
fact1：存储器只有一个衡量其数据传输的指标？没有和总线一样分总线带宽和总线数据传输率
fact2；存储器数据传输率=一直进行传输的速率=max  
数据传输率＝磁道容量×磁盘转速  
$$
D_r=S_t\times V
$$

##### `访问时间`
寻址+数据传输
##### 误码率  
出错位数/所读位数
#### 磁盘 
磁记录原理：信息用磁化方向表示，读/写～感应线圈电流方向  
工作原理  
![Alt text](images/CO_ep7_image-11.png)   
信息记录格式：定长、变长    
![Alt text](images/CO_ep7_image.png)
#### 磁盘阵列 
廉价磁盘冗余阵列RAID(Redundant Array of Inexpensive Disks)  

目的：提高访问性能`并行`和存储可靠性`冗余`  
基本思想：将多个独立操作的磁盘按某种方式组织者成阵列，采用数据分块技术，将数据交错存放在不同磁盘上，使它们`并行工作`来提高访问速度，并通过存储`冗余`的校验信息来提高存储的可靠性

条带：映射的数据单位
条带小：提高单个I/O请求的数据传输率
条带大：提高I/O请求的响应速度

多个物理盘映射`硬|软都行`到一个逻辑盘  
RAID提高存储可靠性的方法：  
用部分条带存放校验信息(有RAID0～RAID7等标准)  
访问时同步进行数据校验  
##### RAID标准
| RAID |描述| S | 传输能力 | 可靠性 |
|---|---|---|---|---|
| 0 | 无冗余 | 最大 | 最好 | 最差 |
| 1 | 镜像 | 最小 | 最差 | 最好 |
| 2<br>3 | `位`交叉海明校验<br>位交叉奇偶校验 | 条带粒度小 | 较高 |测2纠1<br>校验盘1个 |
| 4<br>5 | `块`交叉奇偶校验<br>块交叉`分布`奇偶校验 | 条带粒度大 | 提升<br>解除瓶颈 | 保持<br>校验块错位存放 |
| 6<br>7 | $\cdots$`双重`奇偶校验<br> $\cdots$带cache | 不变 | 降低<br>弥补 | 提升<br>保持 |

#### 光介质存储器`光盘`
光记录原理：  
信息用介质的`不同形态/物态`表示，  
读、写信息用反射光强弱、激光束强弱表示   
形变、相变、磁光  
工作原理： `恒定线速度CLV`  1CLV=1.2m/s 2X 4X  
信息记录格式 
扇区(大小固定、扇角可变) ←提高记录密度  


盘片格式：  
CD(紧致盘)Compact Disk：  
CD-DA、CD-ROM、V-CD  
DVD(数字通用盘)Digital Versatile Disk：   
DVD-VIDEO、DVD-ROM、DVD-RAM  
BD(蓝光盘)Blue-ray Disk：    

组成：盘片+光驱+光控  

面向多媒体，而非信息存储

`一般我们直接塞盘片，光驱光控由计算机提供、不封装，但是磁盘硬件都封装好了，只需要提供软件就行`
#### 固态硬盘SSD-半导体介质辅助存储器
基于FLASH 
闪存芯片
叠栅MOS管作为存储元  
## I/O接口`外设到总线的接口电路`
### 原理
利用一组寄存器(端口)，将主机-外设分为主机-寄存器，寄存器-外设，在差异巨大的双方建立了一层`缓冲`，解决了1.传输协议问题(数据格式)2.速率问题(同步问题)3.物理信号问题(电平差异，模拟-数字)，实现了各种信息的`中转`

`控制逻辑电路的实现是其核心`
### 功能
#### 数据缓冲
用寄存器暂存来自主机和外设的数据   
数据缓冲寄存器
#### 操作中转
用寄存器`控制寄存器`暂存主机的操作命令，并适时转发
#### 状态检测
监测外设状态`就绪`，并暂存到寄存器`状态寄存器`中  
>状态控制寄存器可复用
#### 通信控制
控制信号实现通信协议  
实现与主机通信、与外设通信
#### 信号转换
实现主机-外设间的信号转换(含格式/电平/时序等
### 组成(一般结构)
总线缓冲器、寄存器、设备选择端口、端口地址译码电路、逻辑控制电路、信号转换逻辑电路
![Alt text](images/CO_ep7_image-10.png)
### ~~分类~~
串行、并行`针对外设侧`|可编程、不可编程|`传送控制分类3`
###  对I/O接口的访问
主机-接口的访问：CPU执行相应的机器指令，访问一个I/O端口   
#### I/O端口
在I/O接口中的为可与数据总线交换信息的寄存器(数据口/控制口/状态口)  
#### 端口的编址
##### 统一编址方式
直接使用访存指令  
端口号位数=主存地址空间
如：精简指令系统MIPS的lw rt,disp(rs) 及 sw rt,disp(rs)
##### 独立编址方式时
指令系统需增加I/O指令  
如：8086的IN AL,DX  及 OUT DX,AL`乐x86总共就四条`
>说明：C语言为  
BYTE  _inp(unsigned short usPort);  
BYTE _outp(unsigned short usPort，BYTE btData);
#### 访问接口的时机
取决于软件、I/O控制方式(如查询/中断)
## I/O控制方式`外设传输数据的方式`
### ~~直接传送~~
无控制和状态口，直接传，如拨码开关、LED
![Alt text](images/CO_ep7_image-20.png)
### 程序查询|轮询
多用于字符设控制  
思想：设备启动→循环查询设备工作状态→就绪→传送  
特点：CPU在此期间不能做其他事情，外设CPU串行工作
#### 独占查询
启动后立即开始查询
#### 定时查询
启动后间隔一段时间开始查询  
![Alt text](images/CO_ep7_image-3.png)  
#### I/O接口组织
![Alt text](images/CO_ep7_image-22.png)
### 程序**中断**I/O方式
执行启动外设指令→外设就绪→I/O请求→中断响应→中断处理→中断返回  
将I/O请求作为可屏蔽中断请求，
#### 中断接口组织
向下兼容查询方式EI  
中断请求INT
中断响应INTA
![Alt text](images/CO_ep7_image-21.png)
### **DMA**控制方式
磁盘需求；磁盘→DDR   
利用DMA接口传输，相当于总线让DMA作为主设备，MEM作为从设备   
direct memory access：由DMA接口来控外设-主存信息传输  


TODO 主存与外存的页面置换非常相关  
>DMA方式的存在的意义，将以CPU为中心变为以存储器为中心(完全正确)实现了数据`传送`和`加工`的并行

需要CPU的支持  
１传送准备和结束处理：设置传送字数、设置主存缓冲区、启动设备、数据校验等  
２让出HOST总线控制权
#### 传送方式
CPU访存和DMA接口访存是一对矛盾

| 方式 | 周期条件 | 特点 |
|---|---|---|
| CPU停止访问 | 外设≈主存 | 控制简单 |
| 周期挪用 | 外设>>主存 | I/O优先 |
| 分时交替 | CPU>主存、总线| 透明DMA |

##### 停止CPU访问主存
在DMA接口访存时放弃访存 外设读写周期与主存周期相近  

![Alt text](images/CO_ep7_image-16.png)
##### 周期挪用|窃取
`I/O优先`(I/O>CPU访存)，若CPU访存，等其结束进行DMA   
`外设读写周期>主存`

![Alt text](images/CO_ep7_image-17.png)
##### DMA与CPU交替访问
CPU工作周期比主存周期长  按一个主存周期和DMA轮换
透明DMA 

![Alt text](images/CO_ep7_image-18.png)
#### DMA接口|DMA控制器
MAC -Memory Address Counter主存地址计数器  
WC-Word Counter传送字数计数器  
![Alt text](images/CO_ep7_image-6.png)
#### 传送过程
##### 预处理
e.g. 将磁盘的x磁道y扇区(512B)的数据传送道主存缓冲区(首地址为b)中。设主存按字节编址，DMAC外设端有控制寄存器RegC，数据缓冲寄存器RegB(8bit)，磁道，扇区的主存端口为RegT、RegF，则
$$
{\rm MAC}\leftarrow b\\
{\rm WC}\leftarrow 512\\
{\rm RegC}\leftarrow 周期窃取、写主存\\
{\rm RegC}\leftarrow {\rm DMA}工作方式\\
{\rm RegT}\leftarrow x\\
{\rm RegF}\leftarrow y
$$
##### 数据传送
每次传输一个字，并修改主存地址与传送字数，直到数据传输完毕  
$$
{\rm RegB}\leftarrow {\rm Data}\\
{\rm HRQ}\rightarrow {\rm CPU}\\
{\rm CPU}\rightarrow {\rm HLDA}\\
{\rm ABus}\leftarrow {\rm (MAC)}、
{\rm CBus}\leftarrow {\rm MemW\#}\\
{\rm MAC}+1、{\rm WC}-1\\
{\rm WC}!=0 loop、else中断请求
$$
##### 后处理
用中断处理程序结束工作　　
>注意：CPU的速度中CPU频率和总线时钟频率要区别开来，CPU频率是cpu工作一次的时间，一条指令可能会需CPU工作多次（CPI的意义），而CPU存取一次数据需要一次总线周期，CPU的工作速度会被总线拖累（就取数据而言）  